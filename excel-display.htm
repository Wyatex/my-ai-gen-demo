<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VTable Excel ç™¾ä¸‡çº§æ•°æ®ç­›é€‰ (Web Worker ç‰ˆ)</title>
    
    <!-- SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <!-- VTable -->
    <script src="https://unpkg.com/@visactor/vtable/dist/vtable.min.js"></script>

    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* é¡¶éƒ¨æ§åˆ¶æ  */
        #toolbar {
            height: 70px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: none;
            align-items: center;
            padding: 0 20px;
            gap: 20px;
            box-sizing: border-box;
            flex-shrink: 0;
        }

        .input-wrapper {
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .input-wrapper label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .input-wrapper input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            width: 300px;
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .input-wrapper input:focus {
            outline: none;
            border-color: #4dabf7;
            box-shadow: 0 0 0 3px rgba(77, 171, 247, 0.2);
        }

        #loading-indicator {
            display: none;
            align-items: center;
            color: #2d8cf0;
            font-size: 14px;
            font-weight: bold;
        }
        
        /* ç®€å•çš„åŠ è½½åŠ¨ç”» */
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #2d8cf0;
            border-top: 2px solid transparent;
            border-radius: 50%;
            margin-right: 8px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #btn-reset-file {
            margin-left: auto;
            background-color: #fa5252;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        #btn-reset-file:hover {
            background-color: #e03131;
        }

        /* æ‹–æ‹½åŒºåŸŸ */
        #drop-zone {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 3px dashed #dee2e6;
            margin: 20px;
            border-radius: 12px;
            background-color: #f8f9fa;
            transition: all 0.3s;
            color: #adb5bd;
        }

        #drop-zone.active {
            border-color: #4dabf7;
            background-color: #e7f5ff;
            color: #228be6;
        }

        #drop-zone.hidden {
            display: none;
        }

        #drop-zone h2 {
            margin: 0 0 10px 0;
            color: inherit;
        }

        /* è¡¨æ ¼å®¹å™¨ */
        #table-container {
            flex: 1;
            width: 100%;
            display: none;
            overflow: hidden;
            position: relative;
        }

        /* çŠ¶æ€æ  */
        #status-bar {
            height: 30px;
            background: #fff;
            border-top: 1px solid #eee;
            display: none;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            font-size: 12px;
            color: #888;
        }
        
        .hint {
            color: #228be6;
            font-weight: 600;
        }
    </style>
</head>
<body>

    <div id="toolbar">
        <div class="input-wrapper">
            <label for="filter-include">åŒ…å« (æ”¯æŒ & | æ‹¬å·)</label>
            <input type="text" id="filter-include" placeholder="è¾“å…¥å…³é”®è¯ï¼Œä¾‹å¦‚: A & (B | C)">
        </div>

        <div class="input-wrapper">
            <label for="filter-exclude">æ’é™¤ (æ”¯æŒ & | æ‹¬å·)</label>
            <input type="text" id="filter-exclude" placeholder="è¾“å…¥æ’é™¤è¯">
        </div>

        <div id="loading-indicator">
            <div class="spinner"></div>
            <span id="loading-text">å¤„ç†ä¸­...</span>
        </div>

        <button id="btn-reset-file" onclick="location.reload()">é‡æ–°ä¸Šä¼ </button>
    </div>

    <div id="drop-zone">
        <h2>æ‹–æ‹½ Excel æ–‡ä»¶åˆ°è¿™é‡Œ</h2>
        <p>æ”¯æŒ .xlsx, .xls, .csv (ç™¾ä¸‡è¡Œæ•°æ®æµ‹è¯•ä¼˜åŒ–ç‰ˆ)</p>
    </div>

    <div id="table-container"></div>
    
    <div id="status-bar">
        <span id="record-count"></span>
        <span class="hint">ğŸ’¡ æ”¯æŒæ¡†é€‰å†…å®¹ï¼ŒæŒ‰ Ctrl+C å¤åˆ¶</span>
    </div>

    <!-- 
        =======================================================
        Worker è„šæœ¬é€»è¾‘ (ä½œä¸ºå­—ç¬¦ä¸²åµŒå…¥ï¼Œé¿å…è·¨åŸŸæˆ–å¤šæ–‡ä»¶é—®é¢˜)
        =======================================================
    -->
    <script id="worker-script" type="javascript/worker">
        let originalData = [];
        let searchCache = []; // é¢„å¤„ç†åçš„çº¯æ–‡æœ¬æ•°æ®ï¼Œæå¤§åŠ é€Ÿç­›é€‰

        // é€’å½’é€»è¾‘åˆ¤æ–­å‡½æ•° (ç‹¬ç«‹åœ¨ Worker å†…éƒ¨)
        function evaluateLogic(expression, rowText) {
            if (!expression || expression.trim() === '') return true; 

            let expr = expression;

            // å¤„ç†æ‹¬å·
            while (/\([^()]*\)/.test(expr)) {
                expr = expr.replace(/\(([^()]*)\)/g, (match, content) => {
                    return evaluateLogic(content, rowText) ? "TRUE" : "FALSE";
                });
            }

            const orParts = expr.split('|');
            for (let part of orParts) {
                const andParts = part.split('&');
                const andResult = andParts.every(item => {
                    item = item.trim();
                    if (item === "TRUE") return true;
                    if (item === "FALSE") return false;
                    // ä½¿ç”¨ç¼“å­˜çš„ rowText (å…¨å°å†™) è¿›è¡Œæ¯”è¾ƒ
                    return rowText.includes(item.toLowerCase());
                });

                if (andResult) return true;
            }
            return false;
        }

        self.onmessage = function(e) {
            const { type, payload } = e.data;

            if (type === 'INIT_DATA') {
                // 1. æ¥æ”¶åŸå§‹æ•°æ®
                originalData = payload;
                
                // 2. é¢„å¤„ç†ï¼šç”Ÿæˆæ¯è¡Œçš„æœç´¢å­—ç¬¦ä¸²ç¼“å­˜
                // è¿™æ ·ç­›é€‰æ—¶å°±ä¸éœ€è¦æ¯æ¬¡éƒ½ Object.values().join() äº†ï¼Œæ€§èƒ½æå‡å·¨å¤§
                searchCache = new Array(originalData.length);
                for(let i = 0; i < originalData.length; i++) {
                    // å°†å¯¹è±¡çš„å€¼æ‹¼æ¥æˆå­—ç¬¦ä¸²ï¼Œå¹¶è½¬ä¸ºå°å†™
                    searchCache[i] = Object.values(originalData[i]).join(" ").toLowerCase();
                }

                // 3. é€šçŸ¥ä¸»çº¿ç¨‹å‡†å¤‡å°±ç»ªï¼Œå¹¶è¿”å›å…¨éƒ¨æ•°æ®ç”¨äºåˆæ¬¡æ¸²æŸ“
                self.postMessage({ 
                    type: 'INIT_COMPLETE', 
                    count: originalData.length,
                    data: originalData // åˆæ¬¡æ¸²æŸ“è¿”å›å…¨éƒ¨
                });

            } else if (type === 'FILTER') {
                const { includeExpr, excludeExpr } = payload;
                
                // å¦‚æœæ²¡æœ‰ç­›é€‰æ¡ä»¶ï¼Œç›´æ¥è¿”å›å…¨éƒ¨
                if (!includeExpr && !excludeExpr) {
                    self.postMessage({ 
                        type: 'FILTER_RESULT', 
                        data: originalData 
                    });
                    return;
                }

                const result = [];
                // éå†ç¼“å­˜è¿›è¡Œç­›é€‰
                for (let i = 0; i < searchCache.length; i++) {
                    const rowText = searchCache[i];
                    
                    const isIncluded = evaluateLogic(includeExpr, rowText);
                    let isExcluded = false;
                    if (excludeExpr) {
                        isExcluded = evaluateLogic(excludeExpr, rowText);
                    }

                    if (isIncluded && !isExcluded) {
                        result.push(originalData[i]);
                    }
                }

                self.postMessage({ 
                    type: 'FILTER_RESULT', 
                    data: result 
                });
            }
        };
    </script>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const toolbar = document.getElementById('toolbar');
        const tableContainer = document.getElementById('table-container');
        const statusBar = document.getElementById('status-bar');
        const recordCount = document.getElementById('record-count');
        const inputInclude = document.getElementById('filter-include');
        const inputExclude = document.getElementById('filter-exclude');
        const loadingIndicator = document.getElementById('loading-indicator');
        const loadingText = document.getElementById('loading-text');

        let vTableInstance = null;
        let totalCount = 0;
        let worker = null;

        // --- åˆå§‹åŒ– Worker ---
        function initWorker() {
            const blob = new Blob([document.getElementById('worker-script').textContent], { type: "text/javascript" });
            worker = new Worker(window.URL.createObjectURL(blob));

            worker.onmessage = function(e) {
                const { type, data, count } = e.data;

                if (type === 'INIT_COMPLETE') {
                    loadingIndicator.style.display = 'none';
                    totalCount = count;
                    renderVTable(data); // åˆæ¬¡æ¸²æŸ“
                    updateStatus(data.length);
                } else if (type === 'FILTER_RESULT') {
                    loadingIndicator.style.display = 'none';
                    // åªæ›´æ–°æ•°æ®ï¼Œä¸é‡æ–°åˆ›å»ºè¡¨æ ¼
                    if (vTableInstance) {
                        vTableInstance.setRecords(data);
                    }
                    updateStatus(data.length);
                }
            };
        }

        initWorker();

        // --- é˜²æŠ–å‡½æ•° ---
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    func.apply(context, args);
                }, wait);
            };
        }

        // --- è§¦å‘ç­›é€‰ ---
        function triggerFilter() {
            const includeExpr = inputInclude.value.trim();
            const excludeExpr = inputExclude.value.trim();

            loadingText.textContent = "ç­›é€‰ä¸­...";
            loadingIndicator.style.display = 'flex';

            // å‘é€ç»™ Worker
            worker.postMessage({
                type: 'FILTER',
                payload: { includeExpr, excludeExpr }
            });
        }

        const debouncedFilter = debounce(triggerFilter, 300);

        inputInclude.addEventListener('input', debouncedFilter);
        inputExclude.addEventListener('input', debouncedFilter);

        // --- æ–‡ä»¶æ‹–æ‹½å¤„ç† ---
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, e => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });

        dropZone.addEventListener('dragenter', () => dropZone.classList.add('active'));
        dropZone.addEventListener('dragover', () => dropZone.classList.add('active'));
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('active'));
        dropZone.addEventListener('drop', (e) => {
            dropZone.classList.remove('active');
            const files = e.dataTransfer.files;
            if (files.length > 0) handleFile(files[0]);
        });

        function handleFile(file) {
            loadingText.textContent = "è¯»å–ä¸é¢„å¤„ç†æ•°æ®...";
            loadingIndicator.style.display = 'flex';
            dropZone.classList.add('hidden'); // ç«‹å³éšè—æ‹–æ‹½åŒºï¼Œé¿å…å›°æƒ‘
            toolbar.style.display = 'flex';   // æ˜¾ç¤ºå·¥å…·æ 

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                
                // ä½¿ç”¨ setTimeout è®©å‡ºä¸»çº¿ç¨‹ï¼Œç¡®ä¿ loading åŠ¨ç”»èƒ½æ¸²æŸ“å‡ºæ¥
                setTimeout(() => {
                    try {
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

                        if (jsonData.length === 0) {
                            alert("ç©ºæ–‡ä»¶");
                            loadingIndicator.style.display = 'none';
                            return;
                        }

                        // å°†æ•°æ®å‘é€ç»™ Worker è¿›è¡Œé¢„å¤„ç†
                        worker.postMessage({
                            type: 'INIT_DATA',
                            payload: jsonData
                        });

                    } catch (error) {
                        console.error(error);
                        alert("è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼");
                        loadingIndicator.style.display = 'none';
                    }
                }, 100);
            };
            reader.readAsArrayBuffer(file);
        }

        function updateStatus(currentCount) {
            recordCount.textContent = `æ˜¾ç¤º ${currentCount} æ¡è®°å½• / æ€»è®¡ ${totalCount} æ¡`;
        }

        function renderVTable(data) {
            tableContainer.style.display = 'block';
            statusBar.style.display = 'flex';

            if (vTableInstance) vTableInstance.release();

            const headers = Object.keys(data[0]);
            
            const columns = headers.map(key => ({
                field: key,
                title: key,
                width: 'auto',
                minWidth: 100, 
                sort: true
            }));

            const option = {
                container: tableContainer,
                records: data,
                columns: columns,
                autoWrapText: true,
                limitTitleField: true,
                defaultRowHeight: 40,
                defaultHeaderRowHeight: 50,
                widthMode: 'standard', // æå‡æ€§èƒ½
                
                // æ€§èƒ½ä¼˜åŒ–é…ç½®ï¼šè™šæ‹Ÿæ»šåŠ¨
                // VTable é»˜è®¤å¼€å¯è™šæ‹Ÿæ»šåŠ¨ï¼Œä½†åœ¨å¤§æ•°æ®é‡ä¸‹ç¡®ä¿å¼€å¯å¾ˆé‡è¦
                
                keyboardOptions: {
                    copySelected: true,
                    selectAllOnCtrlA: true,
                    pasteValueToCell: false
                },
                excelOptions: {
                    fillHandle: false,
                },
                interaction: {
                    selection: {
                        type: 'multiple',
                        mode: 'cell'
                    }
                }
            };

            vTableInstance = new VTable.ListTable(option);
        }
    </script>
</body>
</html>
